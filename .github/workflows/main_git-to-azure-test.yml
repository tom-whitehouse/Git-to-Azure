name: Github to Azure pipeline
# Pipeline to run on any push to main, a merge request will already been completed
on:
  push:
    branches:
      - main

jobs:

  # Build Stage - install dependancies and compile code to check safety
  build :
    displayName: Build
    # Skip stage if SAST failed
    condition: in(stageDependencies.SAST.result, 'Succeeded')
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up .NET Core
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: 6.0.x
          include-prerelease: true
      - name: Build with dotnet
        run: dotnet build --configuration Release
      - name: dotnet publish
        run: dotnet publish -c Release -o ${{env.DOTNET_ROOT}}/myapp
      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v2
        with:
          name: .net-app
          path: ${{env.DOTNET_ROOT}}/myapp

  # Deploy Stage - push code to Azure function app
  deploy :
    displayName: Deploy
    # Skip stage if Build failed
    condition: in(stageDependencies.Build.result, 'Succeeded')
    runs-on: windows-latest
    needs: build
    environment:
      name: Production
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v2
        with:
          name: .net-app
      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v2
        with:
          app-name: git-to-azure-test
          slot-name: Production
          publish-profile: ${{
            secrets.AZUREAPPSERVICE_PUBLISHPROFILE_0DE0B866AA134092B8521885CBADC781 }}
          package: .
